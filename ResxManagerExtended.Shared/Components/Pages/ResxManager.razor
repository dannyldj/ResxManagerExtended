@page "/resx-manager"
@using ResxManagerExtended.Shared.Data
@using ResxManagerExtended.Shared.Store
@inherits FluxorComponent

<PageTitle>@Loc["ResxManager"]</PageTitle>

<FluentLayout>
    <FluentLabel Typo="Typography.PaneHeader" MarginBlock="0 20px">
        @Loc["ResxManager"]
    </FluentLabel>

    @if (ResourceState.Value.Nodes is null)
    {
        @if (ResourceState.Value.IsResourceLoading)
        {
            <FluentProgressRing/>
        }
        else
        {
            <FluentLabel>@Loc["DirectorySetupGuide"]</FluentLabel>
        }
    }
    else
    {
        <FluentSplitter Panel1MinSize="250px" Panel1Size="25%"
                        Style="height:-webkit-fill-available;overflow-y:auto">
            <Panel1>
                <FluentTreeView Items="ResourceState.Value.Nodes"
                                SelectedItemChanged="async item => await GetDataGrid(item)"
                                LazyLoadItems="true" Style="overflow:auto">
                    <ItemTemplate>
                        @context.Text.Split(Path.DirectorySeparatorChar).Last()
                    </ItemTemplate>
                </FluentTreeView>
            </Panel1>
            <Panel2>
                <FluentLayout>
                    <FluentStack VerticalAlignment="VerticalAlignment.Center"
                                 HorizontalGap="4" Style="padding:0 0 4px 8px">
                        <FluentCheckbox @bind-Value="_showPath" Label="@Loc["Path"]"/>
                        <FluentCheckbox @bind-Value="_showComment" Label="@Loc["Comment"]"/>
                        <FluentSpacer/>
                        <FluentSearch @bind-Value="_searchValue"
                                      Immediate="true" ImmediateDelay="300"
                                      Placeholder="@Loc["SearchPlaceholder"]"/>
                        <FluentButton Appearance="Appearance.Outline"
                                      IconStart="new Icons.Regular.Size16.ArrowExportUp()"
                                      Title="@Loc["Export"]"
                                      OnClick="() => Dispatcher.Dispatch(new ExportAction([.._cultures], _items))"/>
                        <FluentButton Appearance="Appearance.Outline"
                                      IconStart="new Icons.Regular.Size16.ArrowDownload()"
                                      Title="@Loc["Import"]"
                                      OnClick="() => Dispatcher.Dispatch(new ImportAction())"/>
                    </FluentStack>

                    <div Style="height:100%;overflow:auto">
                        <FluentDataGrid TGridItem="ResourceView"
                                        Items="@SearchedItems" Loading="@_isLoading"
                                        ShowHover="true" Virtualize="true"
                                        GenerateHeader="GenerateHeaderOption.Sticky"
                                        Style="min-width:max-content">
                            <ChildContent>
                                <PropertyColumn Width="200px" Property="@(c => c.Key)" Sortable="true" Tooltip="true"/>

                                @if (_showPath)
                                {
                                    <PropertyColumn Width="200px" Title="@Loc["Path"]" Property="@(c => c.Path)" Sortable="true" Tooltip="true"/>
                                }

                                @if (_showComment)
                                {
                                    <PropertyColumn Width="200px" Title="@Loc["Comment"]" Property="@(c => c.Comment)" Sortable="true" Tooltip="true"/>
                                }

                                @foreach (var culture in _cultures)
                                {
                                    <PropertyColumn Width="300px" Title="@(string.IsNullOrEmpty(culture.Name) ? Loc["NeuturalValue"] : culture.Name)"
                                                    Property="@(c => c.Columns.GetValueOrDefault(culture))" Sortable="true" Tooltip="true"/>
                                }
                            </ChildContent>
                            <EmptyContent>
                                <FluentIcon Value="new Icons.Filled.Size24.Snooze()" Color="@Color.Accent"/>&nbsp; @Loc["NothingHere"]
                            </EmptyContent>
                            <LoadingContent>
                                <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center">
                                    Loading...<br/>
                                    <FluentProgress Width="240px"/>
                                </FluentStack>
                            </LoadingContent>
                        </FluentDataGrid>
                    </div>
                    
                    <FluentOverlay Visible="ResourceState.Value.IsResourceProcessing" Opacity="0.4">
                        <FluentProgressRing/>
                    </FluentOverlay>
                </FluentLayout>
            </Panel2>
        </FluentSplitter>
    }
</FluentLayout>